<!DOCTYPE html>
<html lang="es" class="theme-cream">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demodulador Weaver SSB Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root.theme-cream {
            --color-bg-primary: #fdfaf4;
            --color-bg-secondary: #ffffff;
            --color-text-primary: #3a3a3a;
            --color-text-secondary: #707070;
            --color-border: #e0e0e0;
            --color-accent: #3b82f6; 
            --color-block-info: #eef2ff;
        }
        :root.theme-dark {
            --color-bg-primary: #1e1e1e;
            --color-bg-secondary: #2d2d2d;
            --color-text-primary: #e0e0e0;
            --color-text-secondary: #aaaaaa;
            --color-border: #444444;
            --color-accent: #60a5fa;
            --color-block-info: #374151;
        }
        
        .bg-primary { background-color: var(--color-bg-primary); }
        .bg-secondary { background-color: var(--color-bg-secondary); }
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .border-custom { border-color: var(--color-border); }
        
        .gr-canvas-container {
            position: relative; width: 100%; height: 600px; 
            background-color: var(--color-bg-primary); 
            border: 1px solid var(--color-border);
            border-radius: 8px; overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            user-select: none;
            background-image: radial-gradient(var(--color-border) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .gr-block {
            position: absolute; 
            background-color: #f3f4f6;
            border: 2px solid #333; 
            border-radius: 2px; 
            box-shadow: 2px 2px 4px rgba(0,0,0,0.15); 
            z-index: 10; 
            font-size: 10px; color: black;
            display: flex; flex-direction: column;
            min-width: 100px;
        }
        
        .gr-header {
            background-color: #e5e7eb;
            border-bottom: 1px solid #999;
            padding: 3px 5px;
            font-weight: bold;
            text-align: center;
            font-size: 10px;
        }

        .gr-body { padding: 4px; line-height: 1.3; font-family: monospace; font-size: 9px; }
        .gr-param { margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gr-key { color: #374151; font-weight: 600; }
        .gr-val { color: #000; }

        .gr-port { width: 10px; height: 10px; position: absolute; cursor: pointer; border: 1px solid #000; }
        .type-complex { background-color: #3b82f6; } 
        .type-float { background-color: #f97316; }   
        .port-in { left: -6px; }
        .port-out { right: -6px; }

        .gr-wires svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .gr-wire { fill: none; stroke-width: 2; opacity: 0.8; }
        .wire-c { stroke: #3b82f6; }
        .wire-f { stroke: #f97316; }

        .info-card { @apply bg-block-info p-3 rounded-lg text-xs text-secondary border border-custom mb-3 transition-all hover:shadow-md; }
        .info-title { @apply font-bold text-accent mb-1 block text-sm flex items-center gap-2 border-b border-gray-200 pb-1; }
        .highlight-box { @apply bg-yellow-100 border-l-4 border-yellow-500 p-2 my-2 text-[11px] text-yellow-900; }
    </style>
</head>
<body class="bg-primary text-primary font-sans transition-colors duration-300">

    <main class="min-h-screen p-4 md:p-6 max-w-[1400px] mx-auto flex flex-col gap-6">
        
        <header class="flex justify-between items-center border-b border-custom pb-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-lg flex items-center justify-center text-white font-bold shadow-lg text-2xl">SSB</div>
                <div>
                    <h1 class="text-2xl font-bold text-primary leading-tight">Demodulador SSB Completo (Weaver)</h1>
                    <p class="text-xs text-secondary">Réplica exacta del flujo de señal y control</p>
                </div>
            </div>
            <button id="theme-btn" class="px-4 py-2 rounded-lg bg-secondary border border-custom text-xs font-bold shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700">
                Cambiar Tema
            </button>
        </header>

        <section class="w-full">
            <div class="bg-secondary rounded-xl shadow-lg border border-custom p-1">
                <div class="flex justify-between items-center px-4 py-2 bg-primary border-b border-custom rounded-t-lg">
                    <h3 class="font-bold text-sm text-accent">Flowgraph GNU Radio</h3>
                </div>
                
                <div class="gr-canvas-container" id="canvas-area">
                    <div class="gr-wires">
                        <svg width="1400" height="600">
                            <path d="M 120 280 L 170 280" class="gr-wire wire-c"/>
                            
                            <path d="M 280 270 C 310 270, 310 180, 380 180" class="gr-wire wire-f"/>
                            <path d="M 280 100 C 310 100, 310 200, 380 200" class="gr-wire wire-f"/>
                            <path d="M 460 190 C 500 190, 500 270, 580 270" class="gr-wire wire-f"/>

                            <path d="M 280 290 C 310 290, 310 400, 380 400" class="gr-wire wire-f"/>
                            <path d="M 280 480 C 310 480, 310 420, 380 420" class="gr-wire wire-f"/>
                            <path d="M 460 410 L 510 410" class="gr-wire wire-f"/>
                            <path d="M 610 410 C 640 410, 640 290, 580 290" class="gr-wire wire-f"/>

                            <path d="M 660 280 L 710 280" class="gr-wire wire-f"/>
                            <path d="M 810 280 L 880 280" class="gr-wire wire-f"/>
                            <path d="M 685 280 C 685 350, 685 350, 710 350" class="gr-wire wire-f"/>
                        </svg>
                    </div>


                    <div class="gr-block" style="top: 240px; left: 10px; width: 110px;">
                        <div class="gr-header">Frequency Xlating FIR Filter</div>
                        <div class="gr-body">
                            <div class="gr-param"><span class="gr-key">Decim:</span> 8</div>
                            <div class="gr-param"><span class="gr-key">Taps:</span> firdes.low_pass...</div>
                            <div class="gr-param"><span class="gr-key">Center:</span> 51.5k</div>
                            <div class="gr-param"><span class="gr-key">Sample:</span> 256k</div>
                        </div>
                        <div class="gr-port port-out type-complex" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 250px; left: 170px; width: 110px;">
                        <div class="gr-header">Complex To Float</div>
                        <div class="gr-port port-in type-complex" style="top: 50%;"></div>
                        <div class="gr-port port-out type-float" style="top: 30%;" title="re"></div>
                        <div class="gr-port port-out type-float" style="top: 70%;" title="im"></div>
                    </div>

                    <div class="gr-block" style="top: 50px; left: 160px; width: 120px;">
                        <div class="gr-header">Signal Source</div>
                        <div class="gr-body">
                            <div class="gr-param"><span class="gr-key">Rate:</span> 32k</div>
                            <div class="gr-param"><span class="gr-key">Wave:</span> Cosine</div>
                            <div class="gr-param"><span class="gr-key">Freq:</span> 1.5k</div>
                            <div class="gr-param"><span class="gr-key">Amp:</span> 1</div>
                        </div>
                        <div class="gr-port port-out type-float" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 440px; left: 160px; width: 120px;">
                        <div class="gr-header">Signal Source</div>
                        <div class="gr-body">
                            <div class="gr-param"><span class="gr-key">Rate:</span> 32k</div>
                            <div class="gr-param"><span class="gr-key">Wave:</span> Sine</div>
                            <div class="gr-param"><span class="gr-key">Freq:</span> 1.5k</div>
                            <div class="gr-param"><span class="gr-key">Amp:</span> 1</div>
                        </div>
                        <div class="gr-port port-out type-float" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 170px; left: 380px; width: 80px;">
                        <div class="gr-header">Multiply</div>
                        <div class="gr-port port-in type-float" style="top: 25%;"></div>
                        <div class="gr-port port-in type-float" style="top: 75%;"></div>
                        <div class="gr-port port-out type-float" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 390px; left: 380px; width: 80px;">
                        <div class="gr-header">Multiply</div>
                        <div class="gr-port port-in type-float" style="top: 25%;"></div>
                        <div class="gr-port port-in type-float" style="top: 75%;"></div>
                        <div class="gr-port port-out type-float" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 390px; left: 510px; width: 100px;">
                        <div class="gr-header">Multiply Const</div>
                        <div class="gr-body">
                            <div class="gr-param"><span class="gr-key">Constant:</span> side</div>
                            <div class="gr-param text-[8px] text-gray-500 italic">(-1 para LSB)</div>
                        </div>
                        <div class="gr-port port-in type-float" style="top: 50%;"></div>
                        <div class="gr-port port-out type-float" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 260px; left: 580px; width: 80px;">
                        <div class="gr-header">Add</div>
                        <div class="gr-port port-in type-float" style="top: 25%;"></div>
                        <div class="gr-port port-in type-float" style="top: 75%;"></div>
                        <div class="gr-port port-out type-float" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 260px; left: 710px; width: 100px;">
                        <div class="gr-header">Multiply Const</div>
                        <div class="gr-body">
                            <div class="gr-param"><span class="gr-key">Constant:</span> volumen</div>
                        </div>
                        <div class="gr-port port-in type-float" style="top: 50%;"></div>
                        <div class="gr-port port-out type-float" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 260px; left: 880px; width: 100px;">
                        <div class="gr-header">Audio Sink</div>
                        <div class="gr-body">
                            <div class="gr-param"><span class="gr-key">Rate:</span> 32kHz</div>
                        </div>
                        <div class="gr-port port-in type-float" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 330px; left: 710px; width: 120px;">
                        <div class="gr-header">QT GUI Frequency Sink</div>
                        <div class="gr-body">
                            <div class="gr-param"><span class="gr-key">FFT Size:</span> 1024</div>
                            <div class="gr-param"><span class="gr-key">Center Freq:</span> 0</div>
                            <div class="gr-param"><span class="gr-key">Bandwidth:</span> 32k</div>
                        </div>
                        <div class="gr-port port-in type-float" style="top: 50%;"></div>
                    </div>


                    
                    <div class="gr-block" style="top: 20px; left: 750px; width: 140px; border-color: #666;">
                        <div class="gr-header bg-gray-200">QT GUI Range</div>
                        <div class="gr-body">
                            <div class="gr-param"><span class="gr-key">ID:</span> volumen</div>
                            <div class="gr-param"><span class="gr-key">Default:</span> 20u</div>
                            <div class="gr-param"><span class="gr-key">Start:</span> 0</div>
                            <div class="gr-param"><span class="gr-key">Stop:</span> 100k</div>
                            <div class="gr-param"><span class="gr-key">Step:</span> 100u</div>
                            <input type="range" id="vol-slider" min="0" max="100" value="20" class="w-full mt-1">
                        </div>
                    </div>

                    <div class="gr-block" style="top: 480px; left: 510px; width: 140px; border-color: #666;">
                        <div class="gr-header bg-gray-200">QT GUI Chooser</div>
                        <div class="gr-body">
                            <div class="gr-param"><span class="gr-key">ID:</span> side</div>
                            <div class="gr-param"><span class="gr-key">Num Options:</span> 2</div>
                            <div class="gr-param"><span class="gr-key">Default:</span> 1</div>
                            <div class="gr-param"><span class="gr-key">Option 0:</span> -1</div>
                            <div class="gr-param"><span class="gr-key">Option 1:</span> 1</div>
                            <div class="flex gap-1 mt-1 justify-center">
                                <button id="btn-lsb" class="px-2 py-0.5 bg-blue-200 text-[8px] rounded border border-blue-400">LSB (-1)</button>
                                <button id="btn-usb" class="px-2 py-0.5 bg-gray-200 text-[8px] rounded border border-gray-400">USB (1)</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-6 flex flex-col gap-4">
                <h3 class="font-bold text-lg text-primary border-b border-custom pb-2">Explicación Técnica Detallada</h3>

                <div class="info-card">
                    <span class="info-title">1. Descomposición I/Q (Complex to Float)</span>
                    <p>
                        La señal que recibimos es compleja (tiene dos partes: Real e Imaginaria). Para poder manipular las fases matemáticamente, necesitamos separar estos dos componentes en dos "cables" distintos.
                    </p>
                    <ul class="list-disc pl-4 mt-2 opacity-80">
                        <li><strong>Re (Salida superior):</strong> Componente "En Fase" (I).</li>
                        <li><strong>Im (Salida inferior):</strong> Componente "En Cuadratura" (Q).</li>
                    </ul>
                </div>

                <div class="info-card border-l-4 border-l-orange-500">
                    <span class="info-title">2. ¿Por qué Seno y Coseno a 1.5 kHz?</span>
                    <p class="mb-2">
                        Aquí está el secreto del Weaver. Una señal SSB de voz tiene un ancho de banda de unos 3kHz. Si sintonizamos la portadora en el borde (ej. 51.5k), el centro de la voz queda desplazado 1.5 kHz.
                    </p>
                    <div class="highlight-box">
                        <strong>Matemática pura:</strong> Multiplicar por un seno/coseno es lo mismo que mezclar frecuencias. Al usar 1.5 kHz, estamos empujando la señal de voz para que quede perfectamente centrada en 0 Hz (banda base de audio), lista para escucharse.
                    </div>
                </div>

                <div class="info-card border-l-4 border-l-purple-500">
                    <span class="info-title">3. El Truco del "side" (-1 vs 1)</span>
                    <p>
                        Fíjate en el bloque <strong>QT GUI Chooser</strong> y el <strong>Multiply Const</strong> inferior.
                        Aquí no usamos filtros físicos caros para quitar la banda lateral sobrante. Usamos cancelación de fase.
                    </p>
                    <ul class="list-disc pl-4 mt-2 opacity-80">
                        <li><strong>side = 1 (USB):</strong> Las fases se suman constructivamente en la banda superior y destructivamente en la inferior.</li>
                        <li><strong>side = -1 (LSB):</strong> Al multiplicar la rama Q por -1, invertimos su fase 180 grados. Al llegar al bloque <strong>Add</strong>, la cancelación se invierte: sobrevive la Banda Lateral Inferior.</li>
                    </ul>
                </div>

            </div>

            <div class="lg:col-span-6 flex flex-col gap-4">
                <h3 class="font-bold text-lg text-primary border-b border-custom pb-2">Monitorización en Tiempo Real</h3>
                
                <div class="bg-secondary p-4 rounded-xl shadow border border-custom">
                    <h4 class="font-bold text-sm text-primary mb-2 flex justify-between">
                        <span>Osciloscopio (Audio Sink)</span>
                        <span class="text-xs font-mono text-gray-500">Time Domain</span>
                    </h4>
                    <div class="bg-primary p-2 rounded border border-custom h-40">
                        <canvas id="chart-time"></canvas>
                    </div>
                </div>

                <div class="bg-secondary p-4 rounded-xl shadow border border-custom">
                    <h4 class="font-bold text-sm text-primary mb-2 flex justify-between">
                        <span>Espectro (QT GUI Freq Sink)</span>
                        <span class="text-xs font-mono text-gray-500">Frequency Domain</span>
                    </h4>
                    <div class="bg-primary p-2 rounded border border-custom h-40">
                        <canvas id="chart-freq"></canvas>
                    </div>
                </div>

                <div class="bg-secondary p-3 rounded border border-custom text-xs font-mono flex justify-between items-center">
                    <span>Variable <strong>side</strong>: <span id="val-side" class="text-purple-600 font-bold">1</span></span>
                    <span>Variable <strong>volumen</strong>: <span id="val-vol" class="text-green-600 font-bold">20u</span></span>
                </div>
            </div>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const btnLSB = document.getElementById('btn-lsb');
            const btnUSB = document.getElementById('btn-usb');
            const volSlider = document.getElementById('vol-slider');
            const valSide = document.getElementById('val-side');
            const valVol = document.getElementById('val-vol');
            const themeBtn = document.getElementById('theme-btn');

            let sideState = 1;
            let volState = 20;

            function updateSideButtons() {
                valSide.textContent = sideState;
                if(sideState === -1) {
                    btnLSB.className = "px-2 py-0.5 bg-blue-600 text-white text-[8px] rounded border border-blue-800 font-bold shadow-inner";
                    btnUSB.className = "px-2 py-0.5 bg-gray-200 text-gray-500 text-[8px] rounded border border-gray-400";
                } else {
                    btnUSB.className = "px-2 py-0.5 bg-blue-600 text-white text-[8px] rounded border border-blue-800 font-bold shadow-inner";
                    btnLSB.className = "px-2 py-0.5 bg-gray-200 text-gray-500 text-[8px] rounded border border-gray-400";
                }
            }
            btnLSB.onclick = () => { sideState = -1; updateSideButtons(); };
            btnUSB.onclick = () => { sideState = 1; updateSideButtons(); };
            updateSideButtons();

            volSlider.oninput = (e) => {
                volState = e.target.value;
                valVol.textContent = volState + "u";
            };

            const ctxTime = document.getElementById('chart-time').getContext('2d');
            const chartTime = new Chart(ctxTime, {
                type: 'line',
                data: {
                    labels: Array(100).fill(''),
                    datasets: [{
                        data: Array(100).fill(0),
                        borderColor: '#f97316',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: { legend: { display: false } },
                    scales: { x: {display:false}, y: {min: -2, max: 2, display:false} }
                }
            });

            const ctxFreq = document.getElementById('chart-freq').getContext('2d');
            const chartFreq = new Chart(ctxFreq, {
                type: 'bar',
                data: {
                    labels: Array.from({length:40}, (_,i)=>i),
                    datasets: [{
                        data: Array(40).fill(0),
                        backgroundColor: '#3b82f6',
                        barPercentage: 1.0, categoryPercentage: 1.0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: { legend: { display: false } },
                    scales: { x: {display:false}, y: {min: 0, max: 100, display:false} }
                }
            });

            let t = 0;
            function animate() {
                const timeData = [];
                const freqData = [];
                const volFactor = volState / 50;

                for(let i=0; i<100; i++) {
                    const time = t + i * 0.1;
                    let val = Math.sin(time)*0.5 + Math.sin(time*3)*0.3;
                    
                    if(sideState === -1) val *= -1;

                    val *= volFactor;
                    timeData.push(val);
                }

                for(let i=0; i<40; i++) {
                    let mag = Math.random() * 10;
                    const dist = Math.abs(i - 20);
                    mag += Math.exp(-dist*0.2) * 80 * volFactor;
                    freqData.push(mag);
                }

                chartTime.data.datasets[0].data = timeData;
                chartFreq.data.datasets[0].data = freqData;
                chartTime.update('none');
                chartFreq.update('none');

                t += 0.2;
                requestAnimationFrame(animate);
            }
            animate();

            const themes = ['cream', 'dark'];
            let curTheme = 0;
            themeBtn.onclick = () => {
                curTheme = (curTheme + 1) % themes.length;
                document.documentElement.className = `theme-${themes[curTheme]}`;
            };
        });
    </script>
</body>
</html>