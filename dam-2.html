<!DOCTYPE html>
<html lang="es" class="theme-cream">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demodulación y Decimación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root.theme-cream {
            --color-bg-primary: #fdfaf4;
            --color-bg-secondary: #ffffff;
            --color-text-primary: #3a3a3a;
            --color-text-secondary: #707070;
            --color-border: #e0e0e0;
            --color-accent: #3b82f6;
            --color-chart-grid: rgba(0, 0, 0, 0.1);
            --color-signal-raw: #9ca3af;
            --color-signal-shifted: #f59e0b; 
            --color-signal-final: #10b981;
            --color-block-info: #eef2ff;
        }
        :root.theme-dark {
            --color-bg-primary: #1e1e1e;
            --color-bg-secondary: #2d2d2d;
            --color-text-primary: #e0e0e0;
            --color-text-secondary: #aaaaaa;
            --color-border: #444444;
            --color-accent: #60a5fa;
            --color-chart-grid: rgba(255, 255, 255, 0.2);
            --color-signal-raw: #4b5563;
            --color-signal-shifted: #fbbf24;
            --color-signal-final: #34d399;
            --color-block-info: #374151;
        }
        
        .bg-primary { background-color: var(--color-bg-primary); }
        .bg-secondary { background-color: var(--color-bg-secondary); }
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .border-custom { border-color: var(--color-border); }
        .text-accent { color: var(--color-accent); }
        .bg-block-info { background-color: var(--color-block-info); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .practice-slide { animation: fadeIn 0.5s ease-out; }
        
        html, body { transition: background-color 0.3s ease, color 0.3s ease; }

        .gr-canvas-container {
            position: relative; width: 100%; height: 320px; 
            background-color: var(--color-bg-primary); 
            border: 1px solid var(--color-border);
            border-radius: 8px; overflow-x: auto; overflow-y: hidden;
            font-family: sans-serif; user-select: none;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }
        
        .gr-block {
            position: absolute; 
            background-color: #e6e6ff; 
            border: 2px solid #333; 
            border-radius: 4px; padding: 5px; 
            box-shadow: 2px 2px 6px rgba(0,0,0,0.15); 
            z-index: 10; font-size: 11px; color: black; white-space: nowrap;
        }
        .gr-block:hover { transform: scale(1.02); z-index: 20; border-color: var(--color-accent); cursor: help; }
        .theme-dark .gr-block { background-color: #e0e7ff; border-color: #666; }

        .gr-title { font-weight: bold; text-align: center; border-bottom: 1px solid #999; margin-bottom: 4px; padding-bottom: 2px; }
        .gr-param { font-family: monospace; margin-bottom: 1px; font-size: 10px; }
        
        .gr-port {
            width: 12px; height: 10px; background-color: #3b82f6; border: 1px solid #000;
            position: absolute; cursor: pointer;
        }
        .gr-port.in { left: -7px; } .gr-port.out { right: -7px; }
        
        .gr-wires svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .gr-wire { fill: none; stroke: var(--color-accent); stroke-width: 2; opacity: 0.6; }

        .gnuradio-dialog {
            background-color: var(--color-bg-secondary); border: 1px solid var(--color-border); 
            border-radius: 6px; margin-bottom: 10px; overflow: hidden;
        }
        .gnuradio-header {
            background-color: var(--color-bg-primary); padding: 6px 10px; font-weight: bold; 
            font-size: 0.85rem; border-bottom: 1px solid var(--color-border); color: var(--color-accent);
        }
        .gnuradio-body { padding: 10px; font-size: 0.85rem; }
        
        canvas { max-height: 220px; width: 100%; }
        input[type=range] { height: 6px; border-radius: 5px; cursor: pointer; }

        .info-card { @apply bg-block-info p-3 rounded text-sm text-secondary border border-custom mb-2; }
        .info-title { @apply font-bold text-primary mb-1 block; }
    </style>
</head>
<body class="bg-primary text-primary font-sans">

    <main class="min-h-screen p-4 md:p-6 max-w-[1400px] mx-auto flex flex-col gap-6">
        
        <header class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-accent rounded-lg flex items-center justify-center text-white font-bold shadow-lg">AM</div>
                <div>
                    <h2 class="text-xl font-bold text-accent leading-none">GNURadio</h2>
                    <span class="text-xs text-secondary"> Demodulación Real</span>
                </div>
            </div>
            <button id="theme-toggle-btn" class="p-2 rounded-full bg-secondary border border-custom shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-transform hover:scale-105">
                <span>☀️</span>
            </button>
        </header>

        <section class="w-full">
            <div class="bg-secondary rounded-xl shadow-lg border border-custom p-1">
                <div class="flex justify-between items-center px-4 py-2 border-b border-custom bg-primary rounded-t-lg">
                    <h3 class="font-bold text-accent">1. Flujograma: Traslación y Filtrado</h3>
                    <span class="text-xs text-secondary font-mono">Input SR: 256kHz | Output SR: 64kHz</span>
                </div>
                
                <div class="gr-canvas-container" id="flowgraph-area">
                    <div class="gr-wires">
                        <svg width="1200" height="320">
                            <path d="M 180 85 C 250 85, 250 140, 320 145" class="gr-wire"/>
                            <path d="M 180 225 C 250 225, 250 160, 320 165" class="gr-wire"/>
                            <path d="M 400 155 C 440 155, 440 155, 480 155" class="gr-wire"/>
                            <path d="M 640 155 L 680 155" class="gr-wire"/>
                            <path d="M 680 155 C 720 155, 720 225, 780 225" class="gr-wire"/>
                             <path d="M 680 155 C 720 155, 720 85, 780 85" class="gr-wire" style="stroke-dasharray: 5,5; opacity: 0.4"/>
                        </svg>
                    </div>

                    <div class="gr-block" style="top: 40px; left: 20px; width: 160px;" title="Lee el archivo am_usrp710.dat (complejo)">
                        <div class="gr-title">File Source</div>
                        <div class="gr-param">File: .../am_usrp710.dat</div>
                        <div class="gr-param">Type: Complex</div>
                        <div class="gr-param">Repeat: Yes</div>
                        <div class="gr-port out" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 180px; left: 20px; width: 160px;" title="Genera un tono negativo para bajar la frecuencia">
                        <div class="gr-title">Signal Source</div>
                        <div class="gr-param">Sample Rate: 256k</div>
                        <div class="gr-param">Freq: <span id="lbl-shift-freq">-80k</span></div>
                        <div class="gr-param">Waveform: Cosine</div>
                        <div class="gr-port out" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 130px; left: 320px; width: 80px; height: 50px; display:flex; align-items:center; justify-content:center; font-weight:bold;" title="Mezcla (Mixer): Multiplica señales para trasladar frecuencias">
                        MULT
                        <div class="gr-port in" style="top: 30%;"></div>
                        <div class="gr-port in" style="top: 70%;"></div>
                        <div class="gr-port out" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 90px; left: 480px; width: 160px; border-color: var(--color-signal-final); border-width: 2px;" title="Filtra y reduce la velocidad de muestreo">
                        <div class="gr-title">Low Pass Filter</div>
                        <div class="gr-param">Decimation: <span id="lbl-decim">4</span></div>
                        <div class="gr-param">Sample Rate: 256k</div>
                        <div class="gr-param">Cutoff Freq: 5k</div>
                        <div class="gr-param">Transition: 100</div>
                        <div class="gr-port in" style="top: 50%;"></div>
                        <div class="gr-port out" style="top: 50%;"></div>
                    </div>

                    <div class="gr-block" style="top: 180px; left: 780px; width: 150px;" title="Visualiza el espectro final">
                        <div class="gr-title">QT GUI Freq Sink</div>
                        <div class="gr-param">Center Freq: 0</div>
                        <div class="gr-param">Bandwidth: <span id="lbl-bw">64k</span></div>
                        <div class="gr-port in" style="top: 50%;"></div>
                    </div>
                    
                    <div class="gr-block" style="top: 50px; left: 780px; width: 150px; opacity: 0.6; border-style: dashed;" title="Simulación de salida de audio">
                        <div class="gr-title">Audio Sink</div>
                        <div class="gr-param">Sample Rate: 48k (aprox)</div>
                        <div class="gr-port in" style="top: 50%;"></div>
                    </div>

                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-5 flex flex-col gap-4">
                
                <div class="bg-secondary p-4 rounded-xl shadow border border-custom">
                    <h3 class="font-bold text-primary mb-3 border-b border-custom pb-2">2. El Misterio de los -80kHz</h3>
                    <div class="mb-4">
                        <p class="text-sm text-secondary mb-2">
                            La señal de interés (la voz) fue capturada y se encuentra centrada en <strong>+80kHz</strong> dentro del archivo <code>.dat</code>. Para escucharla, debemos moverla al centro (0Hz, banda base).
                        </p>
                        <div class="bg-primary p-2 rounded text-xs font-mono text-center border border-custom text-accent">
                            e<sup>j(ω_voz)t</sup> · e<sup>-j(80k)t</sup> = e<sup>j(ω_voz - 80k)t</sup>
                        </div>
                        <p class="text-xs text-secondary mt-2">
                            Al multiplicar por una señal de <strong>-80kHz</strong>, restamos 80k a todas las frecuencias. Si la voz estaba en 80k: <br>
                            <strong>80k - 80k = 0 Hz</strong>. ¡Objetivo conseguido!
                        </p>
                    </div>
                    
                    <div class="gnuradio-dialog">
                        <div class="gnuradio-header">Control de Traslación</div>
                        <div class="gnuradio-body">
                            <label class="text-xs font-bold text-secondary">Frecuencia Mixer:</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="range" id="shift-slider" min="-100" max="0" value="-80" class="flex-grow accent-blue-500">
                                <span class="font-mono text-sm w-12 text-right" id="val-shift">-80k</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-secondary p-4 rounded-xl shadow border border-custom flex-grow">
                    <h3 class="font-bold text-primary mb-3 border-b border-custom pb-2">3. El Problema del Sample Rate</h3>
                    
                    <div class="flex items-start gap-3 mb-3">
                        <div class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded border border-red-200 whitespace-nowrap">Problema</div>
                        <p class="text-xs text-secondary">
                            El archivo tiene <strong>256k muestras/seg</strong>. Las tarjetas de audio estándar funcionan a <strong>48k</strong> (o 44.1k). Si enviamos 256k datos a una tarjeta de 48k, ¡se escuchará muy lento y grave!
                        </p>
                    </div>

                    <div class="flex items-start gap-3 mb-3">
                        <div class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded border border-green-200 whitespace-nowrap">Solución</div>
                        <p class="text-xs text-secondary">
                            <strong>Decimación:</strong> Quedarse con una de cada N muestras. 
                            <br>El bloque <strong>Low Pass Filter</strong> hace dos cosas:
                            <ol class="list-decimal pl-4 mt-1 space-y-1">
                                <li><strong>Filtra:</strong> Elimina todo lo que esté fuera de 5kHz (Cutoff) para evitar <em>aliasing</em> y ruido.</li>
                                <li><strong>Decima (4):</strong> Tira 3 de cada 4 muestras.</li>
                            </ol>
                        </p>
                    </div>
                    
                    <div class="bg-block-info p-2 rounded text-center font-mono text-sm border border-custom text-primary font-bold">
                        256.000 / 4 = 64.000 Hz
                    </div>
                    <p class="text-[10px] text-center text-secondary mt-1">64k es mucho más cercano a 48k. El ordenador puede resamplear esa diferencia fácilmente.</p>
                </div>
            </div>

            <div class="lg:col-span-7 flex flex-col gap-4">
                
                <div class="bg-secondary p-4 rounded-xl shadow border border-custom h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-primary">4. Analizador de Espectro (FFT)</h3>
                        <div class="text-xs flex gap-3">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-gray-400"></span> Entrada (Raw)</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> Trasladada</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500 font-bold"></span> Final (Filt)</span>
                        </div>
                    </div>

                    <div class="bg-primary p-2 rounded border border-custom flex-grow relative">
                        <canvas id="spectrum-chart"></canvas>
                        
                        <div class="absolute top-4 left-1/2 -translate-x-1/2 bg-white/90 dark:bg-black/70 px-2 py-1 rounded border border-custom text-xs font-mono">
                            0 Hz (DC)
                        </div>
                        <div class="absolute bottom-2 right-2 text-[10px] text-secondary">
                            Span: ±128kHz
                        </div>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-2 gap-4 text-xs text-secondary">
                        <div class="info-card">
                            <span class="info-title">Parámetros LPF</span>
                            <strong>Cutoff: 5k</strong> → Solo pasa la voz humana.<br>
                            <strong>Transition: 100</strong> → Corte muy abrupto.<br>
                            <strong>Window: Hamming</strong> → Buen balance de filtrado.
                        </div>
                        <div class="info-card border-l-4 border-l-emerald-500">
                            <span class="info-title">Resultado</span>
                            Señal centrada en 0Hz, limpia de ruido y lista para el altavoz.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const themeBtn = document.getElementById('theme-toggle-btn');
            const themes = ['cream', 'dark'];
            let currentThemeIdx = 0;
            
            function updateColors() {
                const style = getComputedStyle(document.documentElement);
                if(window.myChart) {
                    window.myChart.options.scales.x.grid.color = style.getPropertyValue('--color-chart-grid').trim();
                    window.myChart.options.scales.y.grid.color = style.getPropertyValue('--color-chart-grid').trim();
                    window.myChart.update('none');
                }
            }

            themeBtn.addEventListener('click', () => {
                currentThemeIdx = (currentThemeIdx + 1) % themes.length;
                document.documentElement.className = `theme-${themes[currentThemeIdx]}`;
                updateColors();
            });

            const ctx = document.getElementById('spectrum-chart').getContext('2d');
            
            const points = 200;
            const labels = [];
            for(let i=0; i<points; i++) {
                const freq = -128 + (i/points)*256;
                labels.push(freq.toFixed(0));
            }

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Señal Original (.dat)',
                            data: [],
                            borderColor: '#9ca3af',
                            borderWidth: 1,
                            pointRadius: 0,
                            borderDash: [5,5],
                            fill: false
                        },
                        {
                            label: 'Trasladada (Mixer)',
                            data: [],
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Filtrada y Decimada',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { 
                            ticks: { maxTicksLimit: 10, callback: (v) => v + 'k' },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: { 
                            display: false, min: 0, max: 1.2 
                        }
                    }
                }
            });

            const slider = document.getElementById('shift-slider');
            const valLabel = document.getElementById('val-shift');
            const lblShiftFreq = document.getElementById('lbl-shift-freq');
            
            function gaussian(x, center, width) {
                return Math.exp(-0.5 * Math.pow((x - center) / width, 2));
            }

            function animate() {
                const shiftVal = parseInt(slider.val_current || slider.value);
                valLabel.textContent = shiftVal + 'k';
                lblShiftFreq.textContent = shiftVal + 'k';

                const rawData = labels.map(f => {
                    const freq = parseFloat(f);
                    const signal = gaussian(freq, 80, 5);
                    const noise = Math.random() * 0.1;
                    return signal + noise;
                });

                const shiftedCenter = 80 + shiftVal; 
                const shiftedData = labels.map(f => {
                    const freq = parseFloat(f);
                    const signal = gaussian(freq, shiftedCenter, 5);
                    return signal + (Math.random() * 0.1);
                });

                const filteredData = labels.map((f, i) => {
                    const freq = parseFloat(f);
                    let filterResponse = 0;
                    if (Math.abs(freq) < 5) filterResponse = 1;
                    else if (Math.abs(freq) < 10) filterResponse = 1 - (Math.abs(freq)-5)/5;
                    
                    return shiftedData[i] * filterResponse * 1.2;
                });

                window.myChart.data.datasets[0].data = rawData;
                window.myChart.data.datasets[1].data = shiftedData;
                window.myChart.data.datasets[2].data = filteredData;
                
                window.myChart.update('none');
                
                requestAnimationFrame(animate);
            }

            slider.addEventListener('input', () => { slider.val_current = slider.value; });
            
            updateColors();
            animate();
        });
    </script>
</body>
</html>